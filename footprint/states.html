<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <title>US State Totals - Impact Report</title>
    <link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://unpkg.com/tabulator-tables@5.2.7/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.2.7/dist/js/tabulator.min.js"></script>

    <script>
        window.localsite = {
            profile: {
                user: null,
                state: null,
                settings: {}
            }
        };
    </script>

    <script src="../dist/useeio.js"></script>
    <script type="text/javascript" src="/localsite/js/localsite.js?showheader=true&showsearch=true"></script>
    <script src="./config.js"></script>

    <script>
    let table;
    let tableData = [];

    async function main() {
        try {
            console.log("Starting main() for states report");
            const startTime = performance.now();

            // Initializing table first with empty data
            table = new Tabulator("#table", {
                height: 500,
                data: [],
                layout: "fitColumns",
                initialSort: [{column: "output", dir: "desc"}],
                columns: [
                    { 
                        title: "State", 
                        field: "stateName",
                        formatter: function(cell) {
                            const value = cell.getValue();
                            const state = cell.getRow().getData().state;
                            return `<a href="commodities.html#state=${state}">${value}</a>`;
                        },
                        sorter: "string",
                        headerSort: true
                    },
                    { 
                        title: "Output ($)", 
                        field: "outputFormatted",
                        headerSort: true,
                        sorter: function(a, b, aRow, bRow) {
                            return aRow.getData().output - bRow.getData().output;
                        }
                    },
                    { 
                        title: "Jobs", 
                        field: "jobsFormatted",
                        headerSort: true,
                        sorter: function(a, b, aRow, bRow) {
                            return aRow.getData().jobs - bRow.getData().jobs;
                        }
                    }
                ]
            });

            // defining state arrays
            const states = [
                'AL', 'AK', 'AZ', 'AR', 'CA', 'CO', 'CT', 'DE', 'FL', 'GA',
                'HI', 'ID', 'IL', 'IN', 'IA', 'KS', 'KY', 'LA', 'ME', 'MD',
                'MA', 'MI', 'MN', 'MS', 'MO', 'MT', 'NE', 'NV', 'NH', 'NJ',
                'NM', 'NY', 'NC', 'ND', 'OH', 'OK', 'OR', 'PA', 'RI', 'SC',
                'SD', 'TN', 'TX', 'UT', 'VT', 'VA', 'WA', 'WV', 'WI', 'WY'
            ];

            // Processing states in batches
            const batchSize = 5;
            for (let i = 0; i < states.length; i += batchSize) {
                const batch = states.slice(i, i + batchSize);
                const batchStartTime = performance.now();
                
                // Processing states sequentially within each batch to avoid hash changes interference
                const batchResults = [];
                for (const state of batch) {
                    try {
                        // Set hash and wait for model to load
                        window.location.hash = `state=${state}`;
                        await new Promise(resolve => setTimeout(resolve, 100)); //set 100ms timeout for model loading
                        
                        const stateModel = getModel();
                        if (!stateModel) {
                            throw new Error(`Failed to get model for state ${state}`);
                        }

                        // Get state-specific data
                        const stateSectors = await stateModel.sectors();
                        const stateQ = await stateModel.matrix('q');
                        const stateImpacts = await stateModel.matrix('D');
                        const stateIndicator = (await stateModel.indicators()).filter(i => i.code === 'JOBS')[0];

                        // Calculate totals
                        const stateSpecificSectors = stateSectors.filter(row => row.location.includes(state));
                        console.log(`Processing ${state}: Found ${stateSpecificSectors.length} sectors`);
                        
                        const stateTotals = stateSpecificSectors.reduce((acc, sector) => {
                            const output = stateQ.get(sector.index, 0) || 0;
                            const jobs = output * stateImpacts.get(stateIndicator.index, sector.index) || 0;
                            acc.output += output;
                            acc.jobs += jobs;
                            return acc;
                        }, { output: 0, jobs: 0 });

                        batchResults.push({
                            state,
                            stateName: getStateName(state),
                            output: Math.round(stateTotals.output),
                            outputFormatted: formatCell(Math.round(stateTotals.output)),
                            jobs: Math.round(stateTotals.jobs),
                            jobsFormatted: formatCell(Math.round(stateTotals.jobs))
                        });

                        // Add single state result to table immediately
                        await table.addData([batchResults[batchResults.length - 1]]);
                        
                    } catch (error) {
                        console.error(`Error processing state ${state}:`, error);
                    }
                }

                const batchTime = performance.now() - batchStartTime;
                console.log(`Processed batch of ${batch.length} states in ${batchTime.toFixed(2)}ms`);
            }

            // Reset hash and log total time
            window.location.hash = '';
            const totalTime = performance.now() - startTime;
            console.log(`Total processing time: ${totalTime.toFixed(2)}ms`);

        } catch (error) {
            console.error("Error in main():", error);
            document.getElementById("table").innerHTML = 
                `<div style="color: red; padding: 20px;">Error loading data: ${error.message}</div>`;
        }
    }

    // Helper function to get state names
    function getStateName(stateCode) {
        const states = {
        'AL': 'Alabama', 'AK': 'Alaska', 'AZ': 'Arizona', 'AR': 'Arkansas', 'CA': 'California',
        'CO': 'Colorado', 'CT': 'Connecticut', 'DE': 'Delaware', 'FL': 'Florida', 'GA': 'Georgia',
        'HI': 'Hawaii', 'ID': 'Idaho', 'IL': 'Illinois', 'IN': 'Indiana', 'IA': 'Iowa',
        'KS': 'Kansas', 'KY': 'Kentucky', 'LA': 'Louisiana', 'ME': 'Maine', 'MD': 'Maryland',
        'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota', 'MS': 'Mississippi', 'MO': 'Missouri',
        'MT': 'Montana', 'NE': 'Nebraska', 'NV': 'Nevada', 'NH': 'New Hampshire', 'NJ': 'New Jersey',
        'NM': 'New Mexico', 'NY': 'New York', 'NC': 'North Carolina', 'ND': 'North Dakota', 'OH': 'Ohio',
        'OK': 'Oklahoma', 'OR': 'Oregon', 'PA': 'Pennsylvania', 'RI': 'Rhode Island', 'SC': 'South Carolina',
        'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas', 'UT': 'Utah', 'VT': 'Vermont',
        'VA': 'Virginia', 'WA': 'Washington', 'WV': 'West Virginia', 'WI': 'Wisconsin', 'WY': 'Wyoming'
        };
        return states[stateCode] || stateCode;
    }

    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM loaded, starting main");
        main().catch(err => {
            console.error("Failed to initialize:", err);
        });
    });
    </script>
</head>

<body>
    <div class="contentpadding">
        <div style="margin-bottom:10px">
            <h2>State Economic Impact Totals</h2>
        </div>

        <div id="table"></div>
    </div>
</body>
</html>

