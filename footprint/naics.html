<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset='utf-8'>
  <title>NAICS Industries</title>
  <link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://unpkg.com/tabulator-tables@5.2.7/dist/css/tabulator.min.css" rel="stylesheet">
  <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.2.7/dist/js/tabulator.min.js"></script>

  <link rel="stylesheet" href="/localsite/css/base.css" id="/localsite/css/base.css" />
  <script type="text/javascript" src="/localsite/js/localsite.js?showheader=true&showsearch=true"></script>
  <script src="../dist/useeio.js"></script>
  <style>
    .clickable-cell {
      cursor: pointer;
      transition: color 0.3s, background-color 0.3s;
    }

    .clickable-cell:hover {
      color: #0066cc;
      background-color: #f0f0f0;
      text-decoration: underline;
    }
  </style>
</head>

<body>

  <div class="content contentpadding">
    <div style="margin-bottom:10px">
      <a href="./">State Impact Reports</a>
    </div>
    <input type="text" id="naicsInput" placeholder="Enter NAICS Code">
    <button id="fetchButton" style="margin-bottom: 20px">Fetch Data</button>
    <div id="naicsTable" style="margin-bottom: 20px"></div>
    <div id="naicsCodeDisplay"></div>
    <div id="totalRowsDisplay"></div>
  </div>

  <script src="./config.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const naics = await useeio.NaicsMap.of(model);
      const crosswalk = await model.sectorCrosswalk();

      // Fetch all EPA sectors
      async function getEpaSectors() {
        const sectorsJsonFile = "/io/build/api/USEEIOv2.0.1-411/sectors.json";
        try {
          const response = await fetch(sectorsJsonFile);
          const data = await response.json();
          return data.filter(obj => obj.location !== "RoUS");
        } catch (error) {
          console.error("Error fetching EPA sectors:", error);
          return [];
        }
      }

      const epaSectors = await getEpaSectors();

      // Function to find sector name by code
      function findSectorName(code) {
        const sector = epaSectors.find(s => s.code === code);
        return sector ? sector.name : "Unknown";
      }

      // Function to fetch and display NAICS data
      async function fetchAndDisplayNaicsData(naicsCode = null) {
        try {
          let tableData = [];

          // This case is when we are filtering with a particular input

          if (naicsCode) {
            // Fetching data for the specific NAICS code
            const data = await naics.toBea(naicsCode); // Fetching data for the input NAICS code
            tableData = data.map(item => ({
              naicsCode: naicsCode,
              BEA_detail: item,
              sectorName: findSectorName(item), // Finding the sector name for each BEA detail
            }));
          } else {
            // Fetching data for ALL NAICS codes dynamically
            const allNaicsCodes = Object.keys(crosswalk.mappings); // Extracting all NAICS codes

            // Fetching details for each NAICS code
            for (const code of allNaicsCodes) {
              const data = await naics.toBea(code); // Fetching BEA details for each NAICS code
              const codeData = data.map(item => ({
                naicsCode: code, // The current NAICS code
                BEA_detail: item, // BEA detail(s) associated with this code
                sectorName: findSectorName(item), // Finding the sector name for each BEA detail
              }));

              // Adding the fetched data to the table data array
              tableData = tableData.concat(codeData);
            }
          }

          // Updating the Tabulator table with the fetched data
          const table = new Tabulator("#naicsTable", {
            data: tableData,
            columns: [
              { title: "NAICS Code", field: "naicsCode" },
              { title: "BEA Detail", field: "BEA_detail" },
              { title: "Sector Name", field: "sectorName" },
            ],
            layout: "fitColumns",
            pagination: "local",
            paginationSize: 10,
          });

          // Displaying total rows for reference
          document.getElementById("totalRowsDisplay").textContent = `Total Rows: ${tableData.length}`;
        } catch (error) {
          console.error("Error fetching data:", error);
        }
      }

      // Displaying all NAICS data on page load
      fetchAndDisplayNaicsData();

      // Add click event listener for fetching specific NAICS data
      document.getElementById('fetchButton').addEventListener('click', async () => {
        const inputCode = document.getElementById('naicsInput').value.trim();
        await fetchAndDisplayNaicsData(inputCode || null);
      });
    });
  </script>


</body>

</html>