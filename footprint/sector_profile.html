<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8'>
  <title>Sector Analysis - Environmental profile</title>
  <link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://unpkg.com/tabulator-tables@5.2.7/dist/css/tabulator.min.css" rel="stylesheet">
  <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.2.7/dist/js/tabulator.min.js"></script>

  <script type="text/javascript" src="https://model.earth/localsite/js/localsite.js?showheader=true&showsearch=true"></script>
  <script src="../dist/useeio.js"></script>
</head>

<body>

<div class="content contentpadding">
  <a href="./">Footprint Data</a><br>
  <div id="relocatedStateMenu"></div>
  <p id="info">Loading ...</p>
  <div id="table"></div>
</div>

<script src="./config.js"></script>
<script>
document.addEventListener('hashChangeEvent', hashChangedUseeio, false);
function hashChangedUseeio() {
  console.log("URL hash changed");
  model = getModel();
  main();
}

function norm100(nums) {
  let max = 0;
  for (const num of nums) {
    max = Math.max(Math.abs(num), max);
  }
  if (max === 0) {
    return nums;
  }
  const norm = [];
  for (const num of nums) {
    norm.push(100 * num / max)
  }
  return norm;
}

async function main() {
  const info = document.getElementById("info");

  // Parse demandId and sectorIndex from the URL
  const hash = window.location.hash;
  const params = new URLSearchParams(hash.substring(1));
  const demandId = params.get("demand");
  const sectorIndex = params.get("industry");

  if (!demandId) {
    info.textContent = "No demand specified in the URL.";
    return;
  }

  if (!sectorIndex) {
    info.textContent = "No sector specified in the URL.";
    return;
  }

  const sectors = await model.sectors();
  const sector = sectors.find(s => s.index === parseInt(sectorIndex));
  if (!sector) {
    info.textContent = `Sector with index ${sectorIndex} not found.`;
    return;
  }

  info.textContent = `Analyzing sector '${sector.name}' based on demand '${demandId}'`;

  const analysis = await useeio.SectorAnalysis.of(model, sector, demandId);
  const indicators = await model.indicators();
  const direct = norm100(await analysis.getEnvironmentalProfile(true));
  const total = norm100(await analysis.getEnvironmentalProfile(false));
  const results = indicators.map(i => {
    return {
      indicator: `${i.code} - ${i.name}`,
      direct: direct[i.index],
      total: total[i.index],
    };
  });

  info.innerHTML = `<h1>${sector.name}</h1>Environmental profile based on demand <b>${demandId}</b> for <b>${sector.id}</b>`;
  new Tabulator("#table", {
    data: results,
    layout: "fitColumns",
    columns: [
      { title: "Indicator", field: "indicator" },
      { title: "Direct", field: "direct", formatter: "progress" },
      { title: "Total", field: "total", formatter: "progress" },
    ],
  });
}

main();
</script>

</body>
</html>