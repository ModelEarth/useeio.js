<!DOCTYPE html>
<html>

<head>
<meta charset='utf-8'>
<title>US and State Commodities - Impact Report</title>
<link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://unpkg.com/tabulator-tables@5.2.7/dist/css/tabulator.min.css" rel="stylesheet">
<script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.2.7/dist/js/tabulator.min.js"></script>

<!-- <script src="../dist/useeio.min.js"></script> -->
<script src="../dist/useeio.js"></script>
<script type="text/javascript" src="/localsite/js/localsite.js?showheader=true&showsearch=true"></script>

<script src="./config.js"></script>
<script>
document.addEventListener('hashChangeEvent', hashChangedUseeio, false);
function hashChangedUseeio() {
  console.log("URL hash changed");
  model = getModel();
  main();
}

function documentReady(callback) {
    if (document.readyState === "loading") {
        // The document is still loading, wait for it to finish
        document.addEventListener("DOMContentLoaded", callback);
    } else {
        // The DOM is already fully loaded
        callback();
    }
}

let tableData = [];
async function main() {
  try {
    // compute the table data
    const q = await model.matrix('q'); // Commodity
    const sectors = await model.sectors();
    documentReady(function() {
      const notesDiv = document.getElementById("notes");
      if (notesDiv) {
        notesDiv.innerHTML = "<br>From useeio-json/models/2020/" + getModelFolderName() + "/sectors.json<br>";
      }
    });
    const indicator = (await model.indicators()).filter(i => i.code === 'JOBS')[0];
    const impacts = await model.matrix('D'); // Indicator_Sector (like industries)
    
    tableData = sectors.map(sector => {
      const output = q.get(sector.index, 0);
      const jobs = output * impacts.get(indicator.index, sector.index);
      return {
        ...sector,
        output: Math.round(output),
        jobs: Math.round(jobs)
      };
    });
    
    console.log("the table data isï¼š", tableData);
    tableData.forEach(item => { // For each object in array
      item.jobsEasy = formatCell(item.jobs);
      item.outputEasy = "$" + formatCell(item.output);
    });
    
    // Using Tabulator column calculations to compute totals:
    let hash = getHash();
    if (hash.state) {
      // Filter tableData into two parts:
      let stateData = tableData.filter(row => row.location.includes(hash.state));
      let rousData = tableData.filter(row => !row.location.includes(hash.state));
      
      // Create temporary Tabulator instances (in-memory only)
      let stateCalcTable = new Tabulator(document.createElement("div"), {
        data: stateData,
        columns: [
          {field:"output", bottomCalc:"sum"},
          {field:"jobs", bottomCalc:"sum"},
        ],
      });
      let rousCalcTable = new Tabulator(document.createElement("div"), {
        data: rousData,
        columns: [
          {field:"output", bottomCalc:"sum"},
          {field:"jobs", bottomCalc:"sum"},
        ],
      });
      
      // Retrieve the calculated sums
      let stateOutput = stateCalcTable.getCalcResults("output");
      let stateJobs = stateCalcTable.getCalcResults("jobs");
      let rousOutput = rousCalcTable.getCalcResults("output");
      let rousJobs = rousCalcTable.getCalcResults("jobs");
      
      // Update the summary section above the table
      document.getElementById('state-name').textContent = `${hash.state} Total`;
      document.getElementById('state-output').textContent = "$" + formatCell(stateOutput);
      document.getElementById('state-jobs').textContent = formatCell(stateJobs);
      document.getElementById('rous-output').textContent = "$" + formatCell(rousOutput);
      document.getElementById('rous-jobs').textContent = formatCell(rousJobs);
    }
    
    // Now initialize the main table with the tableData
    displayTable(navigator.language, "simple");
    
  } catch(error) {
    console.error("Error in main():", error);
  }
}
main();

var table
function displayTable(locale, formatType) {
  let hash = getHash();
  //You can also pass #index=0 from commodities.html to sector_profile.html
  //But we are not passing index as it may change over time
  const columns = [
    { 
      title: "Commodity", 
      field: "name", 
      formatter: function(cell, formatterParams) {
        const sector = cell.getRow().getData();
        let stateCode = '';
        // Not using since RoUS also needs state= in URL to get the state model.
        //if (sector.location.includes('-')) {
        //  stateCode = sector.location.split('-')[1];
        //}
        if (hash.state) {
          stateCode = hash.state
        }
        const demandHash = `demand=${sector.code}/${sector.location}`;
        const stateParam = stateCode ? `&state=${stateCode}` : '';
        const indexHash = `index=${sector.index}`; // legacy support for old links
        return `<a href="sector_profile.html#${demandHash}${stateParam}">${sector.name}</a>`;
      }
    },
    { 
      title: "Location", 
      field: "location", 
      hozAlign: "right", 
      width: 80 
    },
    {
      title: "Output",
      field:
        formatType === "simple"
          ? "outputEasy"
          : formatType === "full"
          ? "output"
          : formatType === "scientific"
          ? "output"
          : "N/A",
      hozAlign: "right",
      maxWidth: "150px",
      formatter: function (cell, formatterParams) {
        var value = cell.getValue();

        if (formatType === "full") {
          return new Intl.NumberFormat(navigator.language).format(value);
        } else if (formatType === "scientific") {
          let scientificValue = Number(value).toExponential(1);
          let parts = scientificValue.split("e+");
          let base = parts[0];
          let exponent = parts[1];
          return `${base}&times;10<sup>${exponent}</sup>`;
        }
        return value;
      },
      headerSortTristate: false,
      headerSortStartingDir: "desc",
      sorter:
        formatType === "simple"
          ? function (a, b, aRow, bRow, column, dir, sorterParams) {
              let aOutput = aRow.getData().output;
              let bOutput = bRow.getData().output;
              return aOutput - bOutput;
            }
          : undefined,
    },
    {
      title: "Jobs",
      field: formatType === "simple" ? "jobsEasy" : "jobs",
      hozAlign: "right", 
      maxWidth: "100px",
      formatter: function (cell, formatterParams) {
        var value = cell.getValue();
        if (formatType === "full") {
          return new Intl.NumberFormat(locale).format(value);
        } else if (formatType === "scientific") {
          let scientificValue = Number(value).toExponential(1);
          let parts = scientificValue.split("e+");
          let base = parts[0];
          let exponent = parts[1];
          return `${base}&times;10<sup>${exponent}</sup>`;
        }
        return value;
      },
      headerSortTristate: false,
      headerSortStartingDir: "desc",
      sorter:
        formatType === "simple"
          ? function (a, b, aRow, bRow, column, dir, sorterParams) {
              let aJobs = aRow.getData().jobs;
              let bJobs = bRow.getData().jobs;
              return aJobs - bJobs;
            }
          : undefined,
    }
  ];

  table = new Tabulator("#table", {
    height: 500,
    data: tableData,
    layout: "fitColumns",
    columns: columns
  });
}

// Update the table with the selected locale
function updateTable(locale) {

    table.updateColumnDefinition("output", {
        formatter: function(cell, formatterParams) {
            var value = cell.getValue();
            return new Intl.NumberFormat(locale, { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0  }).format(value);
        }
    });

    table.redraw();
}

</script>

<style>
  .summary-card {
    padding: 15px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    min-width: 200px;
  }
  .summary-card h4 {
    margin: 0 0 10px 0;
  }
</style>

</head>

<body>
<!-- <select id="number-format-select"></select> -->
<div class="contentpadding">
  <div style="margin-bottom: 10px; float:right"><select id="number-format-select"></select></div>
  <div style="margin-bottom: 10px; float:right"><select id="locale-select"></select></div>

  <div style="margin-bottom:10px">
    <a id="footprintLink" href="./" >State Impact Reports</a>
  </div>
  <div id="relocatedStateMenu"></div>

  <div id="summary-section" style="margin:20px 0">
    <div style="display:flex; gap:20px; max-width:800px">
      <div class="summary-card">
        <h4 id="state-name">State Total</h4>
        <div>Output: <span id="state-output">-</span></div>
        <div>Jobs: <span id="state-jobs">-</span></div>
      </div>
      <div class="summary-card">
        <h4>Rest of US</h4>
        <div>Output: <span id="rous-output">-</span></div>
        <div>Jobs: <span id="rous-jobs">-</span></div>
      </div>
    </div>
  </div>

  <div id="table" style="clear:both"></div>

  <div id="notes" style="clear:both"></div>

</div>

<script>
  // Populate the locale dropdown
var localeSelect = document.getElementById("locale-select");
var locales = ["en-US", "fr-FR", "de-DE", "es-ES", "it-IT", "ja-JP", "ko-KR", "zh-CN"];

locales.forEach(locale => {
    let option = document.createElement("option");
    option.value = locale;
    option.textContent = locale;
    localeSelect.appendChild(option);
});

// Set the dropdown to the user's current locale
localeSelect.value = navigator.language;

// Add event listener to update table when locale is changed
localeSelect.addEventListener("change", function() {
    updateTable(this.value);
});

// for selecting the number format
let numberFormatToggle = document.getElementById("number-format-select");
let formats = ["simple", "full", "scientific"];
formats.forEach(format => {
    let option = document.createElement("option");
    option.value = format;
    option.textContent = format;
    numberFormatToggle.appendChild(option);
});

// Add event listener to update table when number format is changed
numberFormatToggle.addEventListener("change", function() {
    // // Convert the selected format to a boolean
    // let isSimpleFormat = this.value === "simple";
    displayTable(navigator.language, this.value);
});

</script>

</body>
</html>